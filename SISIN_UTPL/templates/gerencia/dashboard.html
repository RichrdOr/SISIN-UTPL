{% extends 'gerencia/base_gerencia.html' %} {% load static %} {% block title
%}Dashboard Gerencial {% block content %}
<div
    class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6"
>
    <div>
        <h2 class="text-2xl font-bold text-[#111318] dark:text-white">
            Tablero de Control Estratégico
        </h2>
        <p class="text-sm text-[#606e8a] dark:text-[#9aa2b1]">
            Visión Financiera, Operativa y Comercial
        </p>
    </div>
    <button
        onclick="window.print()"
        class="flex items-center gap-2 bg-white dark:bg-[#1e2430] border border-[#dbdfe6] dark:border-[#2a3441] px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-[#2a3441] transition-colors shadow-sm text-[#111318] dark:text-white"
    >
        <span class="material-symbols-outlined text-[20px]">print</span>
        Imprimir
    </button>
</div>

<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div
        class="bg-white dark:bg-[#1e2430] p-4 rounded-xl border border-gray-200 dark:border-[#2a3441] shadow-sm flex items-center gap-4"
    >
        <div class="p-3 rounded-lg bg-blue-50 text-blue-600">
            <span class="material-symbols-outlined">analytics</span>
        </div>
        <div>
            <p class="text-xs font-bold text-gray-500 uppercase">Total Casos</p>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
                {{ kpis.total_gestion }}
            </h3>
        </div>
    </div>
    <div
        class="bg-white dark:bg-[#1e2430] p-4 rounded-xl border border-gray-200 dark:border-[#2a3441] shadow-sm flex items-center gap-4 border-l-4 border-l-green-500"
    >
        <div class="p-3 rounded-lg bg-green-50 text-green-600">
            <span class="material-symbols-outlined">check_circle</span>
        </div>
        <div>
            <p class="text-xs font-bold text-gray-500 uppercase">Cerrados</p>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
                {{ kpis.total_cerrados }}
            </h3>
        </div>
    </div>
    <div
        class="bg-white dark:bg-[#1e2430] p-4 rounded-xl border border-gray-200 dark:border-[#2a3441] shadow-sm flex items-center gap-4 border-l-4 border-l-amber-500"
    >
        <div class="p-3 rounded-lg bg-amber-50 text-amber-600">
            <span class="material-symbols-outlined">pending</span>
        </div>
        <div>
            <p class="text-xs font-bold text-gray-500 uppercase">En Gestión</p>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
                {{ kpis.total_abiertos }}
            </h3>
        </div>
    </div>
    <div
        class="bg-white dark:bg-[#1e2430] p-4 rounded-xl border border-gray-200 dark:border-[#2a3441] shadow-sm flex items-center gap-4 border-l-4 border-l-red-500"
    >
        <div class="p-3 rounded-lg bg-red-50 text-red-600">
            <span class="material-symbols-outlined">warning</span>
        </div>
        <div>
            <p class="text-xs font-bold text-gray-500 uppercase">Vencidos</p>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
                {{ kpis.total_vencidos }}
            </h3>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div
        class="bg-white dark:bg-[#1e2430] p-6 rounded-xl border border-gray-200 dark:border-[#2a3441] shadow-sm flex justify-between items-center"
    >
        <div>
            <p class="text-sm font-bold text-gray-500 uppercase">
                Siniestralidad Semestral
            </p>
            <h2 class="text-4xl font-bold text-blue-600">
                {{ kpis.siniestralidad_pct }}
            </h2>
            <p class="text-xs text-gray-400 mt-1">
                % de Ingresos destinado a pagos
            </p>
        </div>
        <span class="material-symbols-outlined text-6xl text-gray-100"
            >percent</span
        >
    </div>
    <div
        class="bg-white dark:bg-[#1e2430] p-6 rounded-xl border border-gray-200 dark:border-[#2a3441] shadow-sm flex justify-between items-center"
    >
        <div>
            <p class="text-sm font-bold text-gray-500 uppercase">
                Pagos (6 Meses)
            </p>
            <h2 class="text-4xl font-bold text-gray-900 dark:text-white">
                ${{ kpis.monto_pagado_semestre }}
            </h2>
            <p class="text-xs text-gray-400 mt-1">Flujo de caja saliente</p>
        </div>
        <span class="material-symbols-outlined text-6xl text-gray-100"
            >payments</span
        >
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <div
        class="lg:col-span-2 bg-white dark:bg-[#1e2430] rounded-xl border border-gray-200 dark:border-[#2a3441] p-5 shadow-sm"
    >
        <h3 class="font-bold text-gray-900 dark:text-white mb-4">
            Flujo Financiero
        </h3>
        <div class="h-[300px]"><canvas id="chartFinanciero"></canvas></div>
    </div>
    <div
        class="bg-white dark:bg-[#1e2430] rounded-xl border border-gray-200 dark:border-[#2a3441] p-5 shadow-sm"
    >
        <h3 class="font-bold text-gray-900 dark:text-white mb-4">Resolución</h3>
        <div class="h-[300px] flex justify-center">
            <canvas id="chartResolucion"></canvas>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div
        class="bg-white dark:bg-[#1e2430] rounded-xl border border-gray-200 dark:border-[#2a3441] p-5 shadow-sm"
    >
        <h3 class="font-bold text-gray-900 dark:text-white mb-1">
            Rentabilidad por Ramo
        </h3>
        <p class="text-xs text-gray-500 mb-4">Línea Verde = % Siniestralidad</p>
        <div class="h-[300px]"><canvas id="chartRamos"></canvas></div>
    </div>
    <div
        class="bg-white dark:bg-[#1e2430] rounded-xl border border-gray-200 dark:border-[#2a3441] p-5 shadow-sm"
    >
        <h3 class="font-bold text-gray-900 dark:text-white mb-1">
            Tiempos Promedio (Días)
        </h3>
        <p class="text-xs text-gray-500 mb-4">Eficiencia Operativa</p>
        <div class="h-[300px]"><canvas id="chartCiclo"></canvas></div>
    </div>
</div>

<div
    class="bg-white dark:bg-[#1e2430] rounded-xl border border-gray-200 dark:border-[#2a3441] p-5 shadow-sm mb-8"
>
    <h3 class="font-bold text-gray-900 dark:text-white mb-1">
        Matriz de Brokers
    </h3>
    <p class="text-xs text-gray-500 mb-4">Volumen vs Costo Promedio</p>
    <div class="h-[300px]"><canvas id="chartBrokers"></canvas></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    Chart.defaults.font.family = 'Inter';
    Chart.defaults.color = '#64748b';

    // --- LEER DATOS DESDE EL JSON DEL BACKEND ---
    // Usamos 'safe' aquí porque ya vienen comillas desde Python (json.dumps)
    const finLabels = {{ fin_labels_json|safe }};
    const finPrimas = {{ fin_primas_json|safe }};
    const finPagos = {{ fin_pagos_json|safe }};
    const resData = {{ res_data_json|safe }};

    const ramosLabels = {{ ramos_labels_json|safe }};
    const ramosPrimas = {{ ramos_primas_json|safe }};
    const ramosRatio = {{ ramos_ratio_json|safe }};

    const brokerData = {{ scatter_brokers_json|safe }};
    const cicloData = {{ ciclo_data_json|safe }};

    // 1. FINANCIERA
    new Chart(document.getElementById('chartFinanciero'), {
        type: 'bar',
        data: {
            labels: finLabels,
            datasets: [
                { label: 'Ingresos', data: finPrimas, backgroundColor: '#0d59f2', borderRadius: 4 },
                { label: 'Pagos', data: finPagos, backgroundColor: '#ef4444', borderRadius: 4 }
            ]
        },
        options: { maintainAspectRatio: false, scales: { x: { grid: { display: false } } } }
    });

    // 2. RESOLUCIÓN
    new Chart(document.getElementById('chartResolucion'), {
        type: 'doughnut',
        data: {
            labels: ['Cerrados', 'Abiertos', 'Vencidos'],
            datasets: [{ data: resData, backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }]
        },
        options: { maintainAspectRatio: false, cutout: '70%' }
    });

    // 3. RAMOS
    new Chart(document.getElementById('chartRamos'), {
        type: 'bar',
        data: {
            labels: ramosLabels,
            datasets: [
                { label: 'Siniestralidad %', data: ramosRatio, type: 'line', borderColor: '#10b981', borderWidth: 2, yAxisID: 'y1' },
                { label: 'Primas ($)', data: ramosPrimas, backgroundColor: '#0d59f2', yAxisID: 'y' }
            ]
        },
        options: {
            maintainAspectRatio: false,
            scales: { y: { display: false }, y1: { position: 'right', grid: { display: false }, ticks: { callback: v => v + '%' } } }
        }
    });

    // 4. CICLO
    new Chart(document.getElementById('chartCiclo'), {
        type: 'bar', indexAxis: 'y',
        data: {
            labels: ['Reacción Cliente', 'Gestión Interna', 'Pago Tesorería'],
            datasets: [{ label: 'Días Promedio', data: cicloData, backgroundColor: ['#94a3b8', '#f59e0b', '#10b981'], borderRadius: 4 }]
        },
        options: { maintainAspectRatio: false, indexAxis: 'y' }
    });

    // 5. BROKERS
    new Chart(document.getElementById('chartBrokers'), {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Brokers', data: brokerData,
                backgroundColor: ctx => (ctx.raw?.y > 2000 ? '#ef4444' : '#0d59f2'), pointRadius: 6
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                tooltip: { callbacks: { label: ctx => `${ctx.raw.broker}: ${ctx.raw.x} casos, $${ctx.raw.y.toFixed(0)}` } },
                legend: { display: false }
            },
            scales: {
                x: { title: { display: true, text: 'Cantidad' } },
                y: { title: { display: true, text: 'Costo ($)' } }
            }
        }
    });
</script>
{% endblock %}
