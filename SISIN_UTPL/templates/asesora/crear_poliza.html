{% extends "asesora/base.html" %}
{% load static %}

{% block title %}Crear P√≥liza{% endblock %}
{% block header %}Crear Nueva P√≥liza{% endblock %}

{% block content %}
<form method="post" class="space-y-6" id="poliza-form">
  {% csrf_token %}

  <div class="flex items-center gap-4">
    <a href="{% url 'crear_poliza' %}" class="p-2 hover:bg-accent rounded-lg">
      ‚Üê
    </a>
    <div>
      <h2 class="text-xl font-semibold">Crear Nueva P√≥liza</h2>
      <p class="text-muted-foreground text-sm">
        Complete la informaci√≥n de la p√≥liza
      </p>
    </div>
  </div>

  <div class="bg-card rounded-lg border p-6">
    <h3 class="mb-4 pb-3 border-b font-medium">üìÑ Datos Generales</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block text-sm mb-2">N√∫mero de P√≥liza</label>
        <input name="numero_poliza" class="input" placeholder="POL-XXXXX" />
      </div>
      <div>
        <label class="block text-sm mb-2">Titular</label>
        <select name="titular" class="input">
          <option value="">Seleccione un cliente</option>
          {% for cliente in clientes %}
          <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm mb-2">Tipo de P√≥liza</label>
        <select name="tipo_poliza" class="input">
          <option>Hogar</option>
          <option>Comercial</option>
          <option>Industrial</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-2">Aseguradora</label>
        <input name="aseguradora" class="input" placeholder="Nombre de la aseguradora" />
      </div>
      <div>
        <label class="block text-sm mb-2">Fecha Inicio</label>
        <input type="date" name="fecha_inicio" class="input" />
      </div>
      <div>
        <label class="block text-sm mb-2">Fecha Fin</label>
        <input type="date" name="fecha_fin" class="input" />
      </div>
      <div class="col-span-1 md:col-span-2">
        <label class="block text-sm mb-2">Prima</label>
        <input name="prima" class="input" placeholder="0.00" />
      </div>
    </div>
  </div>

  <div class="bg-card rounded-lg border p-6">
    <h3 class="mb-4 pb-3 border-b font-medium">üè† Bien Asegurado</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="col-span-1 md:col-span-2">
        <label class="block text-sm mb-2">Descripci√≥n</label>
        <textarea name="descripcion_bien" rows="3" class="input" placeholder="Descripci√≥n detallada..."></textarea>
      </div>
      <div>
        <label class="block text-sm mb-2">Zona</label>
        <input name="zona" class="input" placeholder="Ubicaci√≥n" />
      </div>
      <div>
        <label class="block text-sm mb-2">Valor</label>
        <input name="valor" class="input" placeholder="0.00" />
      </div>
      <div class="col-span-1 md:col-span-2">
        <label class="block text-sm mb-2">Tipo de Bien</label>
        <select name="tipo_bien" class="input">
          <option>Residencial</option>
          <option>Comercial</option>
          <option>Industrial</option>
        </select>
      </div>
    </div>
  </div>

  <div class="bg-card rounded-lg border p-6">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-2">
        <span class="text-xl">üìä</span>
        <h3 class="font-semibold text-lg">Ramos</h3>
      </div>
      <button type="button" id="add-ramo-btn" class="btn-add">
        <span>+</span> Agregar Ramo
      </button>
    </div>

    {{ formset.management_form }}

    <div class="overflow-x-auto">
      <table class="w-full border-separate border-spacing-y-2">
        <thead>
          <tr class="bg-muted/30">
            <th class="p-3 text-left text-sm font-semibold text-muted-foreground first:rounded-l-lg">Grupo</th>
            <th class="p-3 text-left text-sm font-semibold text-muted-foreground">Subgrupo</th>
            <th class="p-3 text-left text-sm font-semibold text-muted-foreground">Ramo</th>
            <th class="p-3 text-left text-sm font-semibold text-muted-foreground">Suma Asegurada</th>
            <th class="p-3 text-left text-sm font-semibold text-muted-foreground">Deducible %</th>
            <th class="p-3 text-center text-sm font-semibold text-muted-foreground last:rounded-r-lg">Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="ramos-container">
          {% for form in formset %}
          <tr class="ramo-form group bg-white">
            <td class="hidden">
              {{ form.id }}
            </td>
            
            <td class="p-1">
              <input type="text" name="ramos-{{ forloop.counter0 }}-grupo" id="id_ramos-{{ forloop.counter0 }}-grupo" class="input text-sm" placeholder="Ej. Incendio">
            </td>
            <td class="p-1">
              <input type="text" name="ramos-{{ forloop.counter0 }}-subgrupo" id="id_ramos-{{ forloop.counter0 }}-subgrupo" class="input text-sm" placeholder="Subgrupo">
            </td>
            <td class="p-1">
              <input type="text" name="ramos-{{ forloop.counter0 }}-ramo" id="id_ramos-{{ forloop.counter0 }}-ramo" class="input text-sm" placeholder="Ramo">
            </td>
            <td class="p-1">
              <input type="number" step="0.01" name="ramos-{{ forloop.counter0 }}-suma_asegurada" id="id_ramos-{{ forloop.counter0 }}-suma_asegurada" class="input text-sm" placeholder="0.00">
            </td>
            <td class="p-1">
              <input type="number" step="0.01" name="ramos-{{ forloop.counter0 }}-deducible" id="id_ramos-{{ forloop.counter0 }}-deducible" class="input text-sm" placeholder="0%">
            </td>
            <td class="p-2 text-center">
              <button type="button" class="delete-ramo-btn p-2 text-destructive hover:bg-destructive/10 rounded-lg transition-colors">
                <span class="text-lg">üóëÔ∏è</span>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="flex justify-end gap-4">
    <a href="{% url 'crear_poliza' %}" class="px-6 py-3 border rounded-lg hover:bg-accent transition-colors">
      Cancelar
    </a>
    <button type="submit" class="px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:opacity-90 transition-opacity">
      Guardar P√≥liza
    </button>
  </div>
</form>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const addButton = document.getElementById("add-ramo-btn");
    const container = document.getElementById("ramos-container");
    const totalForms = document.getElementById("id_ramos-TOTAL_FORMS");

    addButton.addEventListener("click", function () {
      const currentForms = document.getElementsByClassName("ramo-form");
      const formNum = currentForms.length;
      const newForm = currentForms[0].cloneNode(true);

      // Reemplazar √≠ndices de 0 a N para que Django los reciba correctamente
      const regexName = new RegExp("ramos-0-", "g");
      const regexId = new RegExp("id_ramos-0-", "g");
      
      newForm.innerHTML = newForm.innerHTML.replace(regexName, "ramos-" + formNum + "-");
      newForm.innerHTML = newForm.innerHTML.replace(regexId, "id_ramos-" + formNum + "-");

      // Limpiar los valores de los inputs clonados
      newForm.querySelectorAll("input").forEach(input => {
        input.value = "";
      });

      container.appendChild(newForm);
      
      // Actualizar el Management Form de Django
      totalForms.setAttribute("value", (formNum + 1).toString());
    });

    // Eliminar fila
    container.addEventListener("click", function (e) {
      if (e.target.closest(".delete-ramo-btn")) {
        const forms = document.getElementsByClassName("ramo-form");
        if (forms.length > 1) {
          e.target.closest("tr").remove();
          // Actualizar el contador total tras eliminar
          const newCount = document.getElementsByClassName("ramo-form").length;
          totalForms.setAttribute("value", newCount.toString());
        }
      }
    });
  });
</script>
{% endblock %}