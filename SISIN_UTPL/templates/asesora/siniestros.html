{% extends "asesora/base.html" %}

{% block title %}Siniestros{% endblock %}
{% block header %}Siniestros{% endblock %}

{% block content %}

<div class="container mx-auto px-6 py-8 space-y-8">

  <!-- Mensajes de Django -->
  {% if messages %}
  <div id="django-messages" class="mb-6">
    {% for message in messages %}
    <div class="{% if message.tags == 'success' %}bg-green-100 border-green-500 text-green-700{% elif message.tags == 'error' %}bg-red-100 border-red-500 text-red-700{% elif message.tags == 'warning' %}bg-yellow-100 border-yellow-500 text-yellow-700{% else %}bg-blue-100 border-blue-500 text-blue-700{% endif %} border-l-4 p-4 rounded-lg flex items-center justify-between" role="alert">
      <div class="flex items-center gap-3">
        {% if message.tags == 'success' %}
        <i data-lucide="check-circle" class="w-5 h-5"></i>
        {% elif message.tags == 'error' %}
        <i data-lucide="x-circle" class="w-5 h-5"></i>
        {% elif message.tags == 'warning' %}
        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
        {% else %}
        <i data-lucide="info" class="w-5 h-5"></i>
        {% endif %}
        <span class="font-medium">{{ message }}</span>
      </div>
      <button onclick="this.parentElement.remove()" class="p-1 hover:bg-opacity-20 hover:bg-black rounded">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-foreground mb-1">
        Siniestros
      </h2>
      <p class="text-sm text-muted-foreground">
        Gestión de siniestros y reclamaciones en curso
      </p>
    </div>

    <div class="flex items-center gap-3">
      <button onclick="exportSiniestrosToExcel()" 
              class="flex items-center gap-2 px-4 py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-50 transition">
        <i data-lucide="download" class="w-4 h-4"></i>
        Exportar Excel
      </button>
      
      <a href="{% url 'crear_siniestro' %}"
         class="flex items-center gap-2 px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:opacity-90 transition shadow-lg shadow-primary/20">
        <i data-lucide="plus" class="w-5 h-5"></i>
        Nuevo Siniestro
      </a>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-card p-6 rounded-xl border shadow-sm">
      <div class="flex items-center gap-4">
        <div class="p-3 bg-blue-100 text-blue-600 rounded-lg">
          <i data-lucide="file-text" class="w-6 h-6"></i>
        </div>
        <div>
          <p class="text-sm text-muted-foreground font-medium">Total Siniestros</p>
          <h3 class="text-2xl font-bold">{{ siniestros.count }}</h3>
        </div>
      </div>
    </div>

    <div class="bg-card p-6 rounded-xl border shadow-sm">
      <div class="flex items-center gap-4">
        <div class="p-3 bg-amber-100 text-amber-600 rounded-lg">
          <i data-lucide="clock" class="w-6 h-6"></i>
        </div>
        <div>
          <p class="text-sm text-muted-foreground font-medium">En Revisión</p>
          <h3 class="text-2xl font-bold">
            {% with en_revision=siniestros|dictsort:"estado" %}{% comment %}Lógica simple para demo{% endcomment %}{% endwith %}
            {{ siniestros_revision_count|default:"0" }}
          </h3>
        </div>
      </div>
    </div>

    <div class="bg-card p-6 rounded-xl border shadow-sm">
      <div class="flex items-center gap-4">
        <div class="p-3 bg-green-100 text-green-600 rounded-lg">
          <i data-lucide="check-circle" class="w-6 h-6"></i>
        </div>
        <div>
          <p class="text-sm text-muted-foreground font-medium">Finalizados</p>
          <h3 class="text-2xl font-bold">{{ siniestros_finalizados_count|default:"0" }}</h3>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-card rounded-xl border shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-muted/50 border-b">
          <tr>
            <th class="px-6 py-4 text-left text-muted-foreground font-semibold uppercase tracking-wider text-[11px]">Nº Siniestro</th>
            <th class="px-6 py-4 text-left text-muted-foreground font-semibold uppercase tracking-wider text-[11px]">Póliza / Titular</th>
            <th class="px-6 py-4 text-left text-muted-foreground font-semibold uppercase tracking-wider text-[11px]">Tipo Evento</th>
            <th class="px-6 py-4 text-left text-muted-foreground font-semibold uppercase tracking-wider text-[11px]">Fecha</th>
            <th class="px-6 py-4 text-left text-muted-foreground font-semibold uppercase tracking-wider text-[11px]">Estado</th>
            <th class="px-6 py-4 text-center text-muted-foreground font-semibold uppercase tracking-wider text-[11px]">Acciones</th>
          </tr>
        </thead>

        <tbody class="divide-y">
          {% for siniestro in siniestros %}
          <tr class="hover:bg-accent/50 transition-colors">
            <td class="px-6 py-4 font-medium">{{ siniestro.numero_siniestro }}</td>
            <td class="px-6 py-4">
              <div class="flex flex-col">
                <span class="font-medium text-foreground">{{ siniestro.poliza.numero_poliza }}</span>
                <span class="text-xs text-muted-foreground">{{ siniestro.poliza.titular }}</span>
              </div>
            </td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                {% if siniestro.tipo_evento == 'robo' %}
                <i data-lucide="shield-alert" class="w-4 h-4 text-red-500"></i>
                {% elif siniestro.tipo_evento == 'danio' %}
                <i data-lucide="wrench" class="w-4 h-4 text-orange-500"></i>
                {% elif siniestro.tipo_evento == 'hurto' %}
                <i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-500"></i>
                {% else %}
                <i data-lucide="file-warning" class="w-4 h-4 text-gray-500"></i>
                {% endif %}
                <span class="capitalize">{{ siniestro.get_tipo_evento_display }}</span>
              </div>
            </td>
            <td class="px-6 py-4 text-muted-foreground">
              {{ siniestro.fecha_ocurrencia|date:"d/m/Y" }}
            </td>

            <td class="px-6 py-4">
              {% if siniestro.estado == "reportado" %}
                <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-700">
                  <span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span>
                  Reportado
                </span>
              {% elif siniestro.estado == "en_revision" %}
                <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                  <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                  En revisión
                </span>
              {% elif siniestro.estado == "aprobado" or siniestro.estado == "pagado" %}
                <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                  <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                  {{ siniestro.get_estado_display|default:siniestro.estado|title }}
                </span>
              {% else %}
                <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">
                  <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span>
                  Rechazado
                </span>
              {% endif %}
            </td>

            <td class="px-6 py-4 text-center">
              <a href="{% url 'detalle_siniestro' siniestro.id %}"
                 class="inline-flex items-center justify-center w-8 h-8 rounded-lg border hover:bg-primary hover:text-white transition-all text-muted-foreground"
                 title="Ver detalle">
                <i data-lucide="eye" class="w-4 h-4"></i>
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="px-6 py-12 text-center">
              <div class="flex flex-col items-center gap-2 text-muted-foreground">
                <i data-lucide="file-x-2" class="w-10 h-10 opacity-20"></i>
                <p>No existen siniestros registrados actualmente.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
  // Inicializar iconos
  document.addEventListener('DOMContentLoaded', () => {
    if (window.lucide) {
      lucide.createIcons();
    }
    
    // Auto-ocultar mensajes de Django después de 5 segundos
    const djangoMessages = document.getElementById('django-messages');
    if (djangoMessages) {
      setTimeout(() => {
        djangoMessages.querySelectorAll('[role="alert"]').forEach(alert => {
          alert.style.transition = 'opacity 0.5s ease-out';
          alert.style.opacity = '0';
          setTimeout(() => alert.remove(), 500);
        });
      }, 5000);
    }
  });

  // Función para exportar (Puedes conectarla a tu backend)
  function exportSiniestrosToExcel() {
    console.log("Exportando siniestros...");
    window.location.href = "{% url 'exportar_siniestros_excel' %}"; // Asegúrate de tener esta ruta
  }
</script>

{% endblock %}