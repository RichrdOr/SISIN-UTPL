{% extends "asesora/base.html" %}

{% block title %}Gesti√≥n de P√≥lizas{% endblock %}
{% block header %}Gesti√≥n de P√≥lizas{% endblock %}

{% block content %}

<div class="container mx-auto px-6 py-8">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-foreground mb-2">
        P√≥lizas
      </h2>
      <p class="text-sm text-muted-foreground">
        Gesti√≥n de p√≥lizas de seguros.
      </p>
    </div>

    <div class="flex items-center gap-3">
      <button onclick="exportToExcel()" 
              class="flex items-center gap-2 px-4 py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-50 transition">
        <i data-lucide="download" class="w-4 h-4"></i>
        Exportar Excel
      </button>
      <button onclick="renewExpiredPolicies()" 
              class="flex items-center gap-2 px-4 py-2 border border-orange-600 text-orange-600 rounded-lg hover:bg-orange-50 transition">
        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
        Renovar Vencidas
      </button>
      <a href="{% url 'polizas:formulario_crear_poliza' %}" 
         class="flex items-center gap-2 px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:opacity-90 transition">
        <i data-lucide="plus" class="w-5 h-5"></i>
        Crear P√≥liza
      </a>
    </div>
  </div>

  <!-- Statistics Section -->
  <div class="mt-6 mb-8">
    <!-- Section Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h3 class="text-xl font-bold text-foreground mb-1">
          üìä Estad√≠sticas
        </h3>
        <p class="text-sm text-muted-foreground">
          Resumen de p√≥lizas y m√©tricas importantes
        </p>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="bg-card rounded-lg border p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted-foreground">Total P√≥lizas</p>
            <p class="text-2xl font-bold text-foreground">{{ total_polizas }}</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
            <i data-lucide="file-text" class="w-6 h-6 text-blue-600"></i>
          </div>
        </div>
      </div>

      <div class="bg-card rounded-lg border p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted-foreground">P√≥lizas Activas</p>
            <p class="text-2xl font-bold text-green-600">{{ polizas_activas }}</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
          </div>
        </div>
      </div>

      <div class="bg-card rounded-lg border p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted-foreground">Por Vencer</p>
            <p class="text-2xl font-bold text-yellow-600">{{ polizas_por_vencer }}</p>
          </div>
          <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
            <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-600"></i>
          </div>
        </div>
      </div>

      <div class="bg-card rounded-lg border p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted-foreground">Prima Total</p>
            <p class="text-2xl font-bold text-foreground">${{ prima_total|floatformat:2 }} USD</p>
          </div>
          <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
            <i data-lucide="dollar-sign" class="w-6 h-6 text-purple-600"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="bg-card rounded-lg border p-4 border-red-200">
    <div class="relative">
      <input type="text" 
             placeholder="Buscar por n¬∫ p√≥liza, cliente o ramo"
             class="w-full pl-4 pr-12 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
      <i data-lucide="search" class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground cursor-pointer"></i>
    </div>
  </div>

  <!-- Tabla -->
  <div class="bg-card rounded-lg border overflow-hidden">

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-muted">
          <tr>
            <th class="px-6 py-3 text-left text-muted-foreground font-medium tracking-normal">N¬∫ P√ìLIZA</th>
            <th class="px-6 py-3 text-left text-muted-foreground font-medium">RAMO</th>
            <th class="px-6 py-3 text-left text-muted-foreground font-medium">VIGENCIA</th>
            <th class="px-6 py-3 text-left text-muted-foreground font-medium">COSTO</th>
            <th class="px-6 py-3 text-left text-muted-foreground font-medium">PDF</th>
            <th class="px-6 py-3 text-left text-muted-foreground font-medium">ACCIONES</th>
          </tr>
        </thead>

        <tbody class="divide-y">

          {% for poliza in polizas %}
          <tr id="poliza-{{ poliza.id }}" class="hover:bg-accent transition-colors">

            <td class="px-6 py-4 font-medium tracking-normal">{{ poliza.numero_poliza }}</td>
            
            <!-- Ramo con icono -->
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                {% if 'autom√≥vil' in poliza.tipo_poliza.lower %}
                  <i data-lucide="car" class="w-4 h-4 text-blue-600"></i>
                {% elif 'salud' in poliza.tipo_poliza.lower %}
                  <i data-lucide="heart" class="w-4 h-4 text-red-600"></i>
                {% elif 'hogar' in poliza.tipo_poliza.lower %}
                  <i data-lucide="home" class="w-4 h-4 text-green-600"></i>
                {% elif 'vida' in poliza.tipo_poliza.lower %}
                  <i data-lucide="shield" class="w-4 h-4 text-purple-600"></i>
                {% else %}
                  <i data-lucide="file-text" class="w-4 h-4 text-gray-600"></i>
                {% endif %}
                <span>{{ poliza.tipo_poliza }}</span>
              </div>
            </td>

            <!-- Vigencia -->
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                {% if poliza.estado == "activa" %}
                  <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">Vigente</span>
                {% elif poliza.estado == "suspendida" %}
                  <span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-medium rounded-full">Por Vencer</span>
                {% else %}
                  <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-medium rounded-full">Vencido</span>
                {% endif %}
              </div>
            </td>

            <!-- Costo -->
            <td class="px-6 py-4 font-medium">
              $ {{ poliza.prima|floatformat:2 }} USD
            </td>

            <!-- PDF -->
            <td class="px-6 py-4">
              <a href="{% url 'polizas:descargar_pdf' poliza.id %}" 
                 class="p-2 hover:bg-accent rounded transition-colors inline-block"
                 title="Descargar PDF">
                <i data-lucide="file-text" class="w-4 h-4 text-muted-foreground"></i>
              </a>
            </td>

            <!-- Acciones -->
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <a href="{% url 'polizas:formulario_editar_poliza' poliza.id %}" 
                   class="p-2 hover:bg-accent rounded transition-colors inline-block">
                  <i data-lucide="edit" class="w-4 h-4 text-muted-foreground"></i>
                </a>
                <button onclick="deletePoliza('{{ poliza.id }}')" 
                        class="p-2 hover:bg-accent rounded transition-colors">
                  <i data-lucide="trash-2" class="w-4 h-4 text-red-600"></i>
                </button>
              </div>
            </td>

          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="px-6 py-8 text-center text-muted-foreground">
              No existen p√≥lizas registradas.
            </td>
          </tr>
          {% endfor %}

        </tbody>
      </table>
    </div>

    <!-- Paginaci√≥n -->
    <div class="px-6 py-4 border-t flex items-center justify-between">
      <div class="text-sm text-muted-foreground">
        Mostrando 1 a {{ polizas|length }} de {{ polizas|length }} resultados
      </div>
      <div class="flex items-center gap-2">
        <button class="px-3 py-1 border rounded hover:bg-accent transition-colors disabled:opacity-50" disabled>
          Anterior
        </button>
        <button class="px-3 py-1 border rounded hover:bg-accent transition-colors disabled:opacity-50" disabled>
          Siguiente
        </button>
      </div>
    </div>
  </div>

</div>

<script>
// Si llega ?highlight=<id> desplazarse y resaltar la fila
function getQueryParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}
document.addEventListener('DOMContentLoaded', function(){
  const hid = getQueryParam('highlight');
  if(hid){
    const el = document.getElementById('poliza-' + hid);
    if(el){
      el.scrollIntoView({behavior: 'smooth', block: 'center'});
      el.classList.add('ring','ring-2','ring-primary','bg-yellow-50');
      setTimeout(()=>{ el.classList.remove('bg-yellow-50'); }, 5000);
    }
  }
});
</script>

{% endblock %}
<<<<<<< Updated upstream

{% block extra_js %}
<script>
let currentEditingId = null;
let ramosCountModal = 1;

function openModal() {
  currentEditingId = null;
  document.getElementById('polizaModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  resetForm();
  setTimeout(() => lucide.createIcons(), 100);
}

function closeModal() {
  document.getElementById('polizaModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
  currentEditingId = null;
}

function resetForm() {
  document.getElementById('polizaForm').reset();
  
  // Reset ramos table to default
  const ramosTbody = document.getElementById('ramos-container-modal');
  ramosTbody.innerHTML = `
    <tr class="ramo-form bg-white">
      <td class="p-1"><input name="ramos-0-grupo" class="w-full px-2 py-1 border rounded text-sm" required></td>
      <td class="p-1"><input name="ramos-0-subgrupo" class="w-full px-2 py-1 border rounded text-sm"></td>
      <td class="p-1"><input name="ramos-0-ramo" class="w-full px-2 py-1 border rounded text-sm" required></td>
      <td class="p-1"><input type="number" step="0.01" name="ramos-0-suma_asegurada" class="w-full px-2 py-1 border rounded text-sm" required></td>
      <td class="p-1"><input type="number" step="0.01" name="ramos-0-deducible" class="w-full px-2 py-1 border rounded text-sm"></td>
      <td class="p-2 text-center">
        <button type="button" class="delete-ramo-btn-modal text-red-600 hover:bg-red-50 p-1 rounded">üóëÔ∏è</button>
      </td>
    </tr>
  `;
  
  ramosCountModal = 1;
  setTimeout(() => lucide.createIcons(), 100);
}

// Agregar ramo en modal
document.addEventListener('click', function(e) {
  if (e.target && e.target.id === 'add-ramo-btn-modal') {
    const tbody = document.getElementById('ramos-container-modal');
    const newRow = document.createElement('tr');
    newRow.className = 'ramo-form bg-white';
    newRow.innerHTML = `
      <td class="p-1"><input name="ramos-${ramosCountModal}-grupo" class="w-full px-2 py-1 border rounded text-sm" required></td>
      <td class="p-1"><input name="ramos-${ramosCountModal}-subgrupo" class="w-full px-2 py-1 border rounded text-sm"></td>
      <td class="p-1"><input name="ramos-${ramosCountModal}-ramo" class="w-full px-2 py-1 border rounded text-sm" required></td>
      <td class="p-1"><input type="number" step="0.01" name="ramos-${ramosCountModal}-suma_asegurada" class="w-full px-2 py-1 border rounded text-sm" required></td>
      <td class="p-1"><input type="number" step="0.01" name="ramos-${ramosCountModal}-deducible" class="w-full px-2 py-1 border rounded text-sm"></td>
      <td class="p-2 text-center">
        <button type="button" class="delete-ramo-btn-modal text-red-600 hover:bg-red-50 p-1 rounded">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(newRow);
    ramosCountModal++;
    setTimeout(() => lucide.createIcons(), 50);
  }
  
  if (e.target && e.target.classList.contains('delete-ramo-btn-modal')) {
    e.target.closest('tr').remove();
  }
});

async function editPoliza(id) {
  console.log('Editando p√≥liza:', id);
  currentEditingId = id;
  try {
    const response = await fetch(`/polizas/obtener/${id}/`);
    console.log('Response status:', response.status);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Data received:', data);
    
    // Load data into form
    const numeroPoliza = document.querySelector('[name="numero_poliza"]');
    if (numeroPoliza) {
      numeroPoliza.value = data.numero_poliza || '';
    }
    
    const aseguradora = document.querySelector('[name="aseguradora"]');
    if (aseguradora) {
      aseguradora.value = data.aseguradora || '';
    }
    
    const fechaEmision = document.querySelector('[name="fecha_emision"]');
    if (fechaEmision) {
      fechaEmision.value = data.fecha_emision || '';
    }
    
    const fechaInicio = document.querySelector('[name="fecha_inicio"]');
    if (fechaInicio) {
      fechaInicio.value = data.fecha_inicio || '';
    }
    
    const fechaFin = document.querySelector('[name="fecha_fin"]');
    if (fechaFin) {
      fechaFin.value = data.fecha_fin || '';
    }
    
    const totalPrima = document.querySelector('[name="total_prima"]');
    if (totalPrima) {
      totalPrima.value = data.total_prima || '';
    }
    
    const descripcionBien = document.querySelector('[name="descripcion_bien"]');
    if (descripcionBien) {
      descripcionBien.value = data.descripcion_bien || '';
    }
    
    const tipoBien = document.querySelector('[name="tipo_bien"]');
    if (tipoBien) {
      tipoBien.value = data.tipo_bien || '';
    }
    
    const zona = document.querySelector('[name="zona"]');
    if (zona) {
      zona.value = data.zona || '';
    }
    
    const valorBien = document.querySelector('[name="valor_bien"]');
    if (valorBien) {
      valorBien.value = data.valor_bien || '';
    }
    
    openModal();
    reinitializeIcons();
  } catch (error) {
    console.error('Error loading policy:', error);
    alert('Error al cargar la p√≥liza: ' + error.message);
  }
}

async function deletePoliza(id) {
  console.log('Eliminando p√≥liza:', id);
  if (confirm('¬øEst√°s seguro de que quieres eliminar esta p√≥liza?')) {
    try {
      const response = await fetch(`/polizas/eliminar/${id}/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        }
      });
      
      console.log('Delete response status:', response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('Delete result:', result);
      
      if (result.success) {
        showToast('P√≥liza eliminada exitosamente', 'success');
        location.reload();
      } else {
        showToast('Error al eliminar: ' + result.message, 'error');
      }
    } catch (error) {
      console.error('Error deleting policy:', error);
      showToast('Error al eliminar la p√≥liza', 'error');
    }
  }
}

// Toast notification system
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
  const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info';
  
  toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center gap-3 transform translate-x-full transition-transform duration-300`;
  toast.innerHTML = `
    <i data-lucide="${icon}" class="w-5 h-5"></i>
    <span class="font-medium">${message}</span>
  `;
  
  document.body.appendChild(toast);
  lucide.createIcons();
  
  // Animate in
  setTimeout(() => {
    toast.classList.remove('translate-x-full');
  }, 100);
  
  // Remove after 3 seconds
  setTimeout(() => {
    toast.classList.add('translate-x-full');
    setTimeout(() => {
      document.body.removeChild(toast);
    }, 300);
  }, 3000);
}

// Form submission
async function submitForm(e) {
  e.preventDefault();
  
  const form = e.target;
  const formData = new FormData();
  
  // Add basic policy data
  formData.append('numero_poliza', form.numero_poliza?.value || '');
  formData.append('aseguradora', form.aseguradora?.value || '');
  formData.append('fecha_emision', form.fecha_emision?.value || '');
  formData.append('fecha_inicio', form.fecha_inicio?.value || '');
  formData.append('fecha_fin', form.fecha_fin?.value || '');
  formData.append('total_prima', form.total_prima?.value || '');
  formData.append('descripcion_bien', form.descripcion_bien?.value || '');
  formData.append('tipo_bien', form.tipo_bien?.value || '');
  formData.append('zona', form.zona?.value || '');
  formData.append('valor_bien', form.valor_bien?.value || '');
  
  // Add ramos data
  const ramos = [];
  for (let i = 0; i < ramosCountModal; i++) {
    const grupo = document.querySelector(`[name="ramos-${i}-grupo"]`);
    const subgrupo = document.querySelector(`[name="ramos-${i}-subgrupo"]`);
    const ramo = document.querySelector(`[name="ramos-${i}-ramo"]`);
    const suma = document.querySelector(`[name="ramos-${i}-suma_asegurada"]`);
    const deducible = document.querySelector(`[name="ramos-${i}-deducible"]`);
    
    if (grupo && ramo && suma && grupo.value && ramo.value && suma.value) {
      ramos.push({
        grupo: grupo.value,
        subgrupo: subgrupo?.value || '',
        ramo: ramo.value,
        suma_asegurada: suma.value,
        deducible: deducible?.value || ''
      });
    }
  }
  formData.append('ramos', JSON.stringify(ramos));
  
  // Add PDF file if selected
  const pdfFile = form.pdf_file?.files[0];
  if (pdfFile) {
    formData.append('pdf_file', pdfFile);
  }
  
  // Determine URL and method
  const url = currentEditingId ? `/polizas/editar/${currentEditingId}/` : '/polizas/crear/';
  const method = 'POST';
  
  try {
    const response = await fetch(url, {
      method: method,
      body: formData,
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast(currentEditingId ? 'P√≥liza actualizada exitosamente' : 'P√≥liza creada exitosamente', 'success');
      closeModal();
      location.reload();
    } else {
      showToast('Error: ' + result.message, 'error');
    }
  } catch (error) {
    console.error('Error submitting form:', error);
    showToast('Error al guardar la p√≥liza', 'error');
  }
}

// File selection handler
document.getElementById('pdfInput').addEventListener('change', function(e) {
  const fileName = e.target.files[0]?.name || '';
  document.getElementById('pdfFileName').textContent = fileName ? `Archivo seleccionado: ${fileName}` : '';
});

// Helper function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Form submission event
document.getElementById('polizaForm').addEventListener('submit', submitForm);

// Re-inicializar icons cuando se carga la p√°gina y despu√©s de cambios din√°micos
document.addEventListener('DOMContentLoaded', function() {
  lucide.createIcons();
});

// Funci√≥n para re-inicializar icons (√∫til despu√©s de a√±adir/eliminar elementos)
function reinitializeIcons() {
  setTimeout(() => lucide.createIcons(), 50);
}

// Exportar a Excel
function exportToExcel() {
  console.log('Exportando a Excel...');
  
  // Mostrar indicador de carga
  const button = event.target;
  const originalText = button.innerHTML;
  button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Exportando...';
  button.disabled = true;
  
  // Llamar al backend
  fetch('/polizas/exportar-excel/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    if (response.ok) {
      return response.blob();
    }
    throw new Error('Error en la exportaci√≥n');
  })
  .then(blob => {
    // Descargar archivo
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'polizas_export.xlsx';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    showToast('Exportaci√≥n a Excel completada exitosamente', 'success');
  })
  .catch(error => {
    console.error('Error exportando Excel:', error);
    showToast('Error al exportar a Excel. Por favor, int√©ntelo de nuevo', 'error');
  })
  .finally(() => {
    // Restaurar bot√≥n
    button.innerHTML = originalText;
    button.disabled = false;
    reinitializeIcons();
  });
}

// Renovar p√≥lizas vencidas
function renewExpiredPolicies() {
  console.log('Renovando p√≥lizas vencidas...');
  
  if (confirm('¬øEst√°s seguro de que quieres renovar todas las p√≥lizas vencidas?')) {
    // Mostrar indicador de carga
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Renovando...';
    button.disabled = true;
    
    fetch('/polizas/renovar-vencidas/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast(`Se renovaron ${data.renewed_count} p√≥lizas exitosamente`, 'success');
        location.reload();
      } else {
        showToast('Error al renovar p√≥lizas: ' + data.message, 'error');
      }
    })
    .catch(error => {
      console.error('Error renovando p√≥lizas:', error);
      showToast('Error al renovar las p√≥lizas vencidas', 'error');
    })
    .finally(() => {
      // Restaurar bot√≥n
      button.innerHTML = originalText;
      button.disabled = false;
      reinitializeIcons();
    });
  }
}
</script>
{% endblock %}
=======
>>>>>>> Stashed changes
